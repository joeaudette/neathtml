<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>NeatHtml Test</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<meta http-equiv="expires" content="0">
<script type="text/javascript" src="neathtml.js"></script>
<script type="text/javascript" src="neathtmltest.js"></script>
<style>
.Untrusted {
	counter-increment: untrusted-num;
}

.Untrusted:after {
	content: " #" counter(untrusted-num);
}

#theTest:after {
	content: "";
}
</style>
</head>
<body>
	<a href="?NeatHtmlTestMode=normal">Test with javascript</a>
	<a href="?NeatHtmlTestMode=noscript">Test without javascript (simulated)</a>
	<a href="?NeatHtmlTestMode=unsafe">Test without NeatHtml</a>
	<br />

	<script type="text/javascript">
	// <![CDATA[
NeatHtmlTest.AppendTestStatusElement();	
	// ]]></script>

	<p><em>Please send bugs, comments, and questions to dean at brettle dot com</em>.
	
	<h3 class="Untrusted" id="theTest">The Test</h3>

	<p id="trustedLinkBeforeParent"><a id="trustedLinkBefore" href="#">This link</a>
	will be wired up by trusted script based on it's ID.
	Clicking the link should log a message above.  If it doesn't or a link in untrusted content does, then there is a
	hole.  The script finds the link using document.getElementById("trustedLinkBefore"), 
	so untrusted content needs to be prevented from	containing elements with such an ID.</p>

	<p>Here is the untrusted content:</p>
	<!-- 
		NOTE: After doing the required replace, place the untrusted content inside the div with an ID of "untrusted".
		Everything between here and there is boilerplate that the server would generate.
	-->
	<![if gte IE 7]>
	<div id="container" style="overflow: hidden; position: relative; border: solid 1px;">
	<![endif]>
	<!--[if lt IE 7]>
	<div style="overflow: auto; position: relative; border: solid 1px; width: 100%; height: 400px;">	
	<![endif]-->
	<table><tr><td>
		<!-- test comment --><script type="text/javascript">
		// <![CDATA[
		NeatHtml.DefaultFilter.BeginUntrusted();
		// ]]>
		</script><div id="untrusted">
			<p>Here is a table with lots of XSS attacks and tag soup markup:</p>
			<div id="tagSoup"><NeatHtmlParserReset single='' double=""></NeatHtmlParserReset></td></tr></table><table border=1>
				<tr>
					<th>Script attacks
					<td>script element<br/>
						<script>
						window.alert('XSS from script element');
						</script>
						script elem in CDATA<br/>
						<![CDATA[
						<script>
						window.alert('XSS from script element in CDATA section');
						</script>
						]]>						
					<td>
						<a onclick=window.alert('XSS_on_click') href='http://www.google.com/'>on* attr</a><br />
						<a href=javascript:alert('XSS_on_link')>javascript href</a><br />
					<td id='styleXss' style='nonstandard-attribute1: expression(alert(&quot;XSS from style&quot;)); nonstandard-attribute2: expr/**/ession(alert(&quot;XSS from style with comment&quot;)); nonstandard-attribute3: expres\000073ion(alert(&quot;XSS from style with escape&quot;)); background-color: rgb(192,255,192);'>
						green despite script in style
					<td>
						<a id='trustedLinkBefore' href='http://www.google.com/'>spoof existing ID</a><br />
						<a id='trustedLinkAfter' href='http://www.google.com/'>spoof future ID</a><br />
				<tr>
					<th>Tag soup
					<td><ul><li>no &lt;/li> 1/2<li>no &lt;/li> 2/2</ul>
					<td>unmatched &lt;/em> </em>
					<td><B>varying</B> <i>case</I> <U>tags</u>
					<td><p>line<br>break with &lt;br&gt;
				<tr>
					<th>Special characters and attributes
					<td><a implicit_attr href=http://www.google.com/search?hl=en&q=neathtml&btnG=Search>unquoted and unencoded link</a>
					<td><font face='&#0;
			">non-printable</font> and <font face="&#xdead;'>non-ascii</font> attr values
					<td>A B C with entities: &#65;&nbsp;&#x42;&nbsp;&#X43;
					<td>Unencoded <, and &
			<NeatHtmlParserReset single='' double=""></table><table><tr><td></div>
			
			<p>Below is a 3x3 table nested in the middle cell of another 3x3 table.  If javascript is disabled,
			this will display as 3 separate
			tables (the outer table will be split into 2 pieces).  
			This behavior is a <a href="#Limitations">known limitation</a>.
			<NeatHtmlParserReset single='' double=""></NeatHtmlParserReset></td></tr></table><table border=1>
				<tr><td>0,0</td><td>0,1</td><td>0,2</td></tr>
				<tr><td>1,0</td><td><NeatHtmlParserReset single='' double=""></NeatHtmlParserReset></td></tr></table><table border=1>
				<tr><td>A,A</td><td>A,B</td><td>A,C</td></tr>
				<tr><td>B,A</td><td>B,B</td><td>B,C</td></tr>
				<tr><td>C,A</td><td>C,B</td><td>C,C</td></tr>
			<NeatHtmlParserReset single='' double=""></table><table><tr><td></td><td>1,2</td></tr>
				<tr><td>2,0</td><td>2,1</td><td>2,2</td></tr>
			<NeatHtmlParserReset single='' double=""></table><table><tr><td>

			<p>Try to break out of the layout jail:</p>
			<div style="position: absolute; top: 0; right: 0; color: red;">Let me out!</div>
			<div style="position: absolute; top: -100px; right: 0; color: red;">Let me out with a negative top property!</div>
			
			<p style="counter-increment: untrusted-num;">Here we try to increment the CSS counter used for the 
			"Untrusted Content #x" headings.  If the "attack" succeeds, the next section heading will say "Untrusted Content #3"
			instead of "Untrusted Content #2".  This can only be prevented
			if javascript is enabled.  If the heading just says "Untrusted Content", that just means your browser doesn't support
			the CSS that would be needed for the attack to succeed.</p>
			
			<p>Try to break out of the markup jail...</p>
				<NeatHtmlParserReset single='' double=""></table><table><tr><td>
            </div>
            </div>
            </div>
			<p>Help! Let me out of this box!</p>
			
		</div><xmp></xmp>
		<!-- ' " > -->
		<!-- The preceding comment ensures that the comment and any attrs and tags started
		by the untrusted content have been closed. -->
	</td></tr></table></div><script id="afterContainer" type="text/javascript">
	// <![CDATA[
	NeatHtml.DefaultFilter.ProcessUntrusted();
	// ]]>
	</script>
	<p id="trustedLinkAfterParent"><a id="trustedLinkAfter" href="#">Another link</a> that some trusted script will wire
	up	based on it's ID.
	</p>

	<h3 class="Untrusted">It is a known limitation that we can't keep this from saying "#3" when script is disabled: </h3>

  
	<script type="text/javascript">
	// <![CDATA[
	window.onload = function() 
	{
		NeatHtmlTest.RunTests([
			["Markup invasion blocked", function () {
				var container = document.getElementById("container");
				var afterContainer = document.getElementById("afterContainer");
				NeatHtmlTest.AssertEquals(afterContainer, container.nextSibling);
			}],
			["XSS blocked", function () {
				if (NeatHtmlTest.GetMode() == "noscript")
				{
					NeatHtmlTest.Status = "DISABLED in noscript mode";
					return;
				}
				NeatHtmlTest.AssertEquals(NeatHtmlTest.AlertCalls, 0);
			}],
			["ID spoofing blocked", function () {
				if (NeatHtmlTest.GetMode() == "noscript")
				{
					NeatHtmlTest.Status = "DISABLED in noscript mode";
					return;
				}
				function BeforeClicked()
				{
					NeatHtmlTest.Log("Trusted link before untrusted content clicked."); 
					return false;
				}
				function AfterClicked()
				{
					NeatHtmlTest.Log("Trusted link before untrusted content clicked."); 
					return false;
				}
				document.getElementById("trustedLinkBefore").onclick = BeforeClicked;
				document.getElementById("trustedLinkAfter").onclick = AfterClicked;
				NeatHtmlTest.AssertEquals(BeforeClicked, document.getElementById("trustedLinkBeforeParent").firstChild.onclick);
				NeatHtmlTest.AssertEquals(AfterClicked, document.getElementById("trustedLinkAfterParent").firstChild.onclick);			
			}],
			["Good styles kept", function () {
				if (NeatHtmlTest.GetMode() == "noscript")
				{
					NeatHtmlTest.Status = "DISABLED in noscript mode";
					return;
				}
				var elemWithXssStyle = document.getElementById(NeatHtml.DefaultFilter.IdPrefix + "styleXss");
				NeatHtmlTest.AssertEquals("rgb(192, 255, 192)", elemWithXssStyle.style.backgroundColor);
			}],
			["Tag soup cleaned up", function () {
				if (NeatHtmlTest.GetMode() == "noscript")
				{
					NeatHtmlTest.Status = "DISABLED in noscript mode";
					return;
				}
				var container = document.getElementById(NeatHtml.DefaultFilter.IdPrefix + "tagSoup");
				NeatHtmlTest.AssertEquals('<table border="1">\n'
+'				<tbody><tr>\n'
+'					<th>Script attacks\n'
+'					</th><td>script element<br>\n'
+'						\n'
+'						script elem in CDATA<br>\n'
+'												\n'
+'					</td><td>\n'
+'						<a href="http://www.google.com/">on* attr</a><br>\n'
+'						<a>javascript href</a><br>\n'
+'					</td><td id="NeatHtml_styleXss" style="background-color: rgb(192, 255, 192);">\n'
+'						green despite script in style\n'
+'					</td><td>\n'
+'						<a id="NeatHtml_trustedLinkBefore" href="http://www.google.com/">spoof existing ID</a><br>\n'
+'						<a id="NeatHtml_trustedLinkAfter" href="http://www.google.com/">spoof future ID</a><br>\n'
+'				</td></tr><tr>\n'
+'					<th>Tag soup\n'
+'					</th><td><ul><li>no &lt;/li&gt; 1/2</li><li>no &lt;/li&gt; 2/2</li></ul>\n'
+'					</td><td>unmatched &lt;/em&gt; \n'
+'					</td><td><b>varying</b> <i>case</i> <u>tags</u>\n'
+'					</td><td><p>line<br>break with &lt;br&gt;\n'
+'				</p></td></tr><tr>\n'
+'					<th>Special characters and attributes\n'
+'					</th><td><a href="http://www.google.com/search?hl=en&amp;q=neathtml&amp;btnG=Search">unquoted and unencoded link</a>\n'
+'					</td><td><font face="face">non-printable</font> and <font face="face">non-ascii</font> attr values\n'
+'					</td><td>A B C with entities: A&nbsp;B&nbsp;C\n'
+'					</td><td>Unencoded &lt;, and &amp;\n'
+'			</td></tr></tbody></table>', container.innerHTML);
			}],
		]);
	}
	// ]]>
	</script>
</body>
</html>